<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Minesweeper</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-container">
        <h1>Ultimate Minesweeper</h1>
        
        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-item">
                <span class="stat-label">Score:</span>
                <span id="score">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Streak:</span>
                <span id="streak">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">High Score:</span>
                <span id="highScore">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Time:</span>
                <span id="timer">0:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Gems:</span>
                <span id="gemsCollected">0</span>💎
            </div>
        </div>

        <!-- Game Mode Selection -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="classic">Classic</button>
            <button class="mode-btn" data-mode="survival">Survival</button>
            <button class="mode-btn" data-mode="blitz">Blitz</button>
            <button class="mode-btn" data-mode="zen">Zen</button>
        </div>

        <!-- Theme Selector -->
        <div class="theme-selector">
            <button class="theme-btn active" data-theme="default">Default</button>
            <button class="theme-btn" data-theme="dark">Dark</button>
            <button class="theme-btn" data-theme="neon">Neon</button>
            <button class="theme-btn" data-theme="space">Space</button>
        </div>

        <!-- Difficulty Selector -->
        <div class="difficulty-selector">
            <button class="diff-btn active" data-size="5" data-mines="1">Easy (5x5)</button>
            <button class="diff-btn" data-size="6" data-mines="2">Medium (6x6)</button>
            <button class="diff-btn" data-size="7" data-mines="3">Hard (7x7)</button>
            <button class="diff-btn" data-size="8" data-mines="4">Expert (8x8)</button>
        </div>

        <div class="game-board" id="gameBoard">
            <!-- Grid will be generated by JavaScript -->
        </div>
        
        <!-- Power-ups -->
        <div class="powerups">
            <button id="hintBtn" class="powerup-btn" onclick="useHint()">
                🔍 Hint (<span id="hintsLeft">3</span>)
            </button>
            <button id="undoBtn" class="powerup-btn" onclick="useUndo()">
                ↶ Undo (<span id="undosLeft">1</span>)
            </button>
            <button id="safeRevealBtn" class="powerup-btn" onclick="useSafeReveal()">
                🛡️ Safe (<span id="safeRevealsLeft">2</span>)
            </button>
        </div>

        <div class="game-controls">
            <button id="resetBtn" onclick="resetGame()">New Game</button>
            <button id="shareBtn" onclick="shareResult()">Share Result</button>
            <button id="achievementsBtn" onclick="showAchievements()">Achievements</button>
        </div>

        <!-- Achievement Notifications -->
        <div class="achievement-notification" id="achievementNotification">
            <div class="achievement-content">
                <span class="achievement-icon">🏆</span>
                <div class="achievement-text">
                    <div class="achievement-title"></div>
                    <div class="achievement-desc"></div>
                </div>
            </div>
        </div>

        <!-- Particle Container -->
        <div class="particle-container" id="particleContainer"></div>

        <!-- Custom popup overlay -->
        <div class="popup-overlay" id="popupOverlay">
            <div class="popup">
                <h2 id="popupTitle">Game Over!</h2>
                <p id="popupMessage">You hit a mine!</p>
                <div id="popupStats"></div>
                <div class="popup-buttons">
                    <button onclick="closePopup(); resetGame();">Play Again</button>
                    <button onclick="shareResult()">Share</button>
                </div>
            </div>
        </div>

        <!-- Achievements Panel -->
        <div class="achievements-overlay" id="achievementsOverlay">
            <div class="achievements-panel">
                <h2>Achievements</h2>
                <div id="achievementsList"></div>
                <button onclick="closeAchievements()">Close</button>
            </div>
        </div>

        <!-- Reset Progress Button -->
        <div class="reset-progress">
            <button id="resetProgressBtn" onclick="showResetConfirm()">🗑️ Reset Progress</button>
        </div>

        <!-- Reset Confirmation Popup -->
        <div class="popup-overlay" id="resetConfirmOverlay">
            <div class="popup">
                <h2>⚠️ Reset Progress</h2>
                <p>This will permanently delete:</p>
                <ul style="text-align: left; margin: 15px 0;">
                    <li>All achievements</li>
                    <li>High scores</li>
                    <li>Win streaks</li>
                    <li>Total gems collected</li>
                    <li>Game statistics</li>
                </ul>
                <p><strong>This action cannot be undone!</strong></p>
                <div class="popup-buttons">
                    <button onclick="closeResetConfirm()" style="background: linear-gradient(145deg, #757575, #424242);">Cancel</button>
                    <button onclick="resetAllProgress()" style="background: linear-gradient(145deg, #f44336, #d32f2f);">Reset Everything</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let board = [];
        let gameState = 'playing';
        let currentMode = 'classic';
        let currentTheme = 'default';
        let boardSize = 5;
        let minesCount = 1;
        let minePositions = [];
        let gameStats = {
            score: 0,
            streak: 0,
            highScore: localStorage.getItem('highScore') || 0,
            gemsCollected: parseInt(localStorage.getItem('totalGems')) || 0,
            gamesPlayed: parseInt(localStorage.getItem('gamesPlayed')) || 0,
            gamesWon: parseInt(localStorage.getItem('gamesWon')) || 0
        };
        let gameTimer = { seconds: 0, interval: null };
        let powerUps = { hints: 3, undos: 1, safeReveals: 2 };
        let lastMove = null;
        let roundCount = 0;
        let blitzRounds = 0;
        let achievements = [];
        
        // Drag functionality variables
        let isDragging = false;
        let dragStartCell = null;
        let draggedCells = new Set();

        // Sound effects
        const sounds = {
            gemFound: () => playSound(800, 0.1, 'sine'),
            mineHit: () => playSound(150, 0.3, 'sawtooth'),
            win: () => playWinSound(),
            achievement: () => playSound(1000, 0.2, 'triangle')
        };

        function playSound(frequency, duration, type = 'sine') {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playWinSound() {
            const notes = [523, 659, 784, 1047];
            notes.forEach((note, i) => {
                setTimeout(() => playSound(note, 0.2, 'sine'), i * 100);
            });
        }

        // Initialize achievements
        function initAchievements() {
            const achievementList = [
                { id: 'firstWin', name: 'First Victory', desc: 'Win your first game', icon: '🏆', unlocked: false },
                { id: 'streak5', name: 'Lucky Streak', desc: 'Win 5 games in a row', icon: '🔥', unlocked: false },
                { id: 'speed10', name: 'Speed Demon', desc: 'Win in under 10 seconds', icon: '⚡', unlocked: false },
                { id: 'gems100', name: 'Gem Collector', desc: 'Collect 100 gems total', icon: '💎', unlocked: false },
                { id: 'survival10', name: 'Survivor', desc: 'Survive 10 rounds in survival mode', icon: '🛡️', unlocked: false },
                { id: 'perfectGame', name: 'Flawless Victory', desc: 'Win without using any powerups', icon: '🌟', unlocked: false },
                { id: 'blitzMaster', name: 'Blitz Master', desc: 'Complete 5 blitz rounds', icon: '💨', unlocked: false },
                { id: 'expert', name: 'Expert Player', desc: 'Win on Expert difficulty', icon: '🎯', unlocked: false }
            ];
            
            const saved = localStorage.getItem('achievements');
            if (saved) {
                achievements = JSON.parse(saved);
            } else {
                achievements = achievementList;
            }
        }

        function checkAchievements() {
            const checks = [
                { id: 'firstWin', condition: () => gameStats.gamesWon >= 1 },
                { id: 'streak5', condition: () => gameStats.streak >= 5 },
                { id: 'speed10', condition: () => gameTimer.seconds <= 10 && gameState === 'won' },
                { id: 'gems100', condition: () => gameStats.gemsCollected >= 100 },
                { id: 'survival10', condition: () => currentMode === 'survival' && roundCount >= 10 },
                { id: 'perfectGame', condition: () => gameState === 'won' && powerUps.hints === 3 && powerUps.undos === 1 && powerUps.safeReveals === 2 },
                { id: 'blitzMaster', condition: () => currentMode === 'blitz' && blitzRounds >= 5 },
                { id: 'expert', condition: () => gameState === 'won' && boardSize === 8 }
            ];

            checks.forEach(check => {
                const achievement = achievements.find(a => a.id === check.id);
                if (achievement && !achievement.unlocked && check.condition()) {
                    achievement.unlocked = true;
                    showAchievementNotification(achievement);
                    sounds.achievement();
                }
            });

            localStorage.setItem('achievements', JSON.stringify(achievements));
        }

        function showAchievementNotification(achievement) {
            const notification = document.getElementById('achievementNotification');
            const title = notification.querySelector('.achievement-title');
            const desc = notification.querySelector('.achievement-desc');
            const icon = notification.querySelector('.achievement-icon');
            
            title.textContent = achievement.name;
            desc.textContent = achievement.desc;
            icon.textContent = achievement.icon;
            
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Theme system
        function setTheme(theme) {
            currentTheme = theme;
            document.body.className = theme + '-theme';
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
        }

        // Game mode handlers
        function setGameMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            if (mode === 'zen') {
                stopTimer();
                document.getElementById('timer').style.display = 'none';
            } else {
                document.getElementById('timer').style.display = 'inline';
            }
            
            resetGame();
        }

        function setDifficulty(size, mines) {
            boardSize = parseInt(size);
            minesCount = parseInt(mines);
            document.querySelectorAll('.diff-btn').forEach(btn => {
                btn.classList.toggle('active', 
                    btn.dataset.size === size && btn.dataset.mines === mines);
            });
            resetGame();
        }

        // Timer functions
        function startTimer() {
            if (currentMode === 'zen') return;
            gameTimer.seconds = 0;
            gameTimer.interval = setInterval(() => {
                gameTimer.seconds++;
                updateTimerDisplay();
                
                if (currentMode === 'blitz' && gameTimer.seconds >= 30) {
                    gameState = 'lost';
                    showPopup('Time\'s Up!', 'You ran out of time in Blitz mode!');
                }
            }, 1000);
        }

        function stopTimer() {
            if (gameTimer.interval) {
                clearInterval(gameTimer.interval);
                gameTimer.interval = null;
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameTimer.seconds / 60);
            const seconds = gameTimer.seconds % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Score system
        function calculateScore() {
            let baseScore = (boardSize * boardSize - minesCount) * 10;
            let timeBonus = Math.max(0, 60 - gameTimer.seconds) * 5;
            let streakBonus = gameStats.streak * 50;
            let difficultyMultiplier = boardSize / 5;
            
            return Math.round((baseScore + timeBonus + streakBonus) * difficultyMultiplier);
        }

        function updateScore(points) {
            gameStats.score += points;
            document.getElementById('score').textContent = gameStats.score;
        }

        function updateStats() {
            document.getElementById('score').textContent = gameStats.score;
            document.getElementById('streak').textContent = gameStats.streak;
            document.getElementById('highScore').textContent = gameStats.highScore;
            document.getElementById('gemsCollected').textContent = gameStats.gemsCollected;
        }

        // Particle effects
        function createParticles(x, y, color = '#4caf50') {
            const container = document.getElementById('particleContainer');
            for (let i = 0; i < 6; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = color;
                
                const angle = (i / 6) * Math.PI * 2;
                const velocity = 50 + Math.random() * 30;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity;
                
                particle.style.setProperty('--vx', vx + 'px');
                particle.style.setProperty('--vy', vy + 'px');
                
                container.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        // Screen shake effect
        function screenShake() {
            document.body.style.animation = 'shake 0.5s';
            setTimeout(() => document.body.style.animation = '', 500);
        }

        // Initialize the game
        function initGame() {
            board = [];
            gameState = 'playing';
            minePositions = [];
            lastMove = null;
            powerUps = { hints: 3, undos: 1, safeReveals: 2 };
            
            if (currentMode === 'survival') {
                roundCount++;
            } else if (currentMode === 'blitz') {
                blitzRounds = 0;
            } else {
                roundCount = 0;
                gameStats.score = 0;
            }
            
            // Create empty board
            for (let i = 0; i < boardSize; i++) {
                board[i] = [];
                for (let j = 0; j < boardSize; j++) {
                    board[i][j] = {
                        isMine: false,
                        isRevealed: false,
                        isFlagged: false,
                        neighborCount: 0
                    };
                }
            }
            
            // Place mines randomly
            placeMines();
            
            // Calculate neighbor counts
            calculateNumbers();
            
            // Render the board
            renderBoard();
            updateStats();
            updatePowerUpDisplay();
            
            if (currentMode !== 'zen') {
                startTimer();
            }
        }

        function placeMines() {
            minePositions = [];
            let minesPlaced = 0;
            
            while (minesPlaced < minesCount) {
                const row = Math.floor(Math.random() * boardSize);
                const col = Math.floor(Math.random() * boardSize);
                
                if (!board[row][col].isMine) {
                    board[row][col].isMine = true;
                    minePositions.push({ row, col });
                    minesPlaced++;
                }
            }
        }

        function calculateNumbers() {
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    if (!board[i][j].isMine) {
                        board[i][j].neighborCount = countNeighborMines(i, j);
                    }
                }
            }
        }

        function countNeighborMines(row, col) {
            let count = 0;
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const newRow = row + i;
                    const newCol = col + j;
                    if (newRow >= 0 && newRow < boardSize && 
                        newCol >= 0 && newCol < boardSize && 
                        board[newRow][newCol].isMine) {
                        count++;
                    }
                }
            }
            return count;
        }

        function renderBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${boardSize}, 1fr)`;
            gameBoard.style.gridTemplateRows = `repeat(${boardSize}, 1fr)`;
            
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.setAttribute('data-row', i);
                    cell.setAttribute('data-col', j);
                    
                    if (board[i][j].isRevealed) {
                        cell.classList.add('revealed');
                        if (board[i][j].isMine) {
                            cell.innerHTML = '💎';
                            cell.classList.add('mine');
                        } else {
                            cell.innerHTML = '💎';
                            cell.classList.add('safe');
                        }
                    }
                    
                    if (board[i][j].isFlagged) {
                        cell.innerHTML = '🚩';
                        cell.classList.add('flagged');
                    }
                    
                    cell.addEventListener('click', () => handleCellClick(i, j));
                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleRightClick(i, j);
                    });
                    
                    // Add drag functionality
                    cell.addEventListener('mousedown', (e) => handleMouseDown(e, i, j));
                    cell.addEventListener('mouseenter', () => handleMouseEnter(i, j));
                    cell.addEventListener('mouseup', () => handleMouseUp());
                    
                    // Prevent text selection during drag
                    cell.addEventListener('selectstart', (e) => e.preventDefault());
                    
                    gameBoard.appendChild(cell);
                }
            }
        }

        function handleCellClick(row, col) {
            if (gameState !== 'playing' || board[row][col].isRevealed || board[row][col].isFlagged) {
                return;
            }
            
            lastMove = { row, col, action: 'reveal' };
            revealCell(row, col);
            
            if (board[row][col].isMine) {
                gameState = 'lost';
                revealAllMines();
                screenShake();
                sounds.mineHit();
                stopTimer();
                gameStats.streak = 0;
                gameStats.gamesPlayed++;
                localStorage.setItem('gamesPlayed', gameStats.gamesPlayed);
                localStorage.setItem('streak', 0);
                showGameOverPopup();
            } else {
                sounds.gemFound();
                gameStats.gemsCollected++;
                updateScore(10);
                
                const rect = event.target.getBoundingClientRect();
                createParticles(rect.left + rect.width/2, rect.top + rect.height/2);
                
                checkWinCondition();
            }
            
            renderBoard();
            updateStats();
            localStorage.setItem('totalGems', gameStats.gemsCollected);
            checkAchievements();
        }

        function handleRightClick(row, col) {
            if (gameState !== 'playing' || board[row][col].isRevealed) {
                return;
            }
            
            lastMove = { row, col, action: 'flag', wasFlagged: board[row][col].isFlagged };
            board[row][col].isFlagged = !board[row][col].isFlagged;
            renderBoard();
        }

        // Drag functionality
        function handleMouseDown(event, row, col) {
            if (event.button !== 0) return; // Only left mouse button
            if (gameState !== 'playing' || board[row][col].isRevealed || board[row][col].isFlagged) {
                return;
            }
            
            isDragging = true;
            dragStartCell = { row, col };
            draggedCells.clear();
            draggedCells.add(`${row}-${col}`);
            
            // Add visual feedback for drag start
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            cell.classList.add('drag-highlight');
            
            // Prevent default to avoid text selection
            event.preventDefault();
        }

        function handleMouseEnter(row, col) {
            if (!isDragging || gameState !== 'playing') return;
            if (board[row][col].isRevealed || board[row][col].isFlagged) return;
            
            const cellKey = `${row}-${col}`;
            if (!draggedCells.has(cellKey)) {
                draggedCells.add(cellKey);
                
                // Add visual feedback
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                cell.classList.add('drag-highlight');
            }
        }

        function handleMouseUp() {
            if (!isDragging) return;
            
            isDragging = false;
            
            // Process all dragged cells
            const cellsToReveal = Array.from(draggedCells);
            let hitMine = false;
            let revealedCount = 0;
            
            // Remove visual feedback and reveal cells
            cellsToReveal.forEach(cellKey => {
                const [row, col] = cellKey.split('-').map(Number);
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                cell.classList.remove('drag-highlight');
                
                if (!board[row][col].isRevealed && !board[row][col].isFlagged) {
                    revealCell(row, col);
                    revealedCount++;
                    
                    if (board[row][col].isMine) {
                        hitMine = true;
                    } else {
                        sounds.gemFound();
                        gameStats.gemsCollected++;
                        updateScore(10);
                        
                        // Create particles for each revealed gem
                        const rect = cell.getBoundingClientRect();
                        setTimeout(() => {
                            createParticles(rect.left + rect.width/2, rect.top + rect.height/2);
                        }, Math.random() * 200); // Stagger particle effects
                    }
                }
            });
            
            // Handle game state
            if (hitMine) {
                gameState = 'lost';
                revealAllMines();
                screenShake();
                sounds.mineHit();
                stopTimer();
                gameStats.streak = 0;
                gameStats.gamesPlayed++;
                localStorage.setItem('gamesPlayed', gameStats.gamesPlayed);
                localStorage.setItem('streak', 0);
                showGameOverPopup();
            } else if (revealedCount > 0) {
                checkWinCondition();
            }
            
            // Clear drag state
            draggedCells.clear();
            dragStartCell = null;
            
            renderBoard();
            updateStats();
            localStorage.setItem('totalGems', gameStats.gemsCollected);
            checkAchievements();
        }

        function revealCell(row, col) {
            if (row < 0 || row >= boardSize || col < 0 || col >= boardSize || 
                board[row][col].isRevealed || board[row][col].isFlagged) {
                return;
            }
            
            board[row][col].isRevealed = true;
        }

        function revealAllMines() {
            minePositions.forEach(pos => {
                board[pos.row][pos.col].isRevealed = true;
            });
        }

        function checkWinCondition() {
            let revealedCount = 0;
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    if (board[i][j].isRevealed && !board[i][j].isMine) {
                        revealedCount++;
                    }
                }
            }
            
            if (revealedCount === boardSize * boardSize - minesCount) {
                gameState = 'won';
                stopTimer();
                sounds.win();
                
                gameStats.streak++;
                gameStats.gamesWon++;
                gameStats.gamesPlayed++;
                
                const roundScore = calculateScore();
                updateScore(roundScore);
                
                if (gameStats.score > gameStats.highScore) {
                    gameStats.highScore = gameStats.score;
                    localStorage.setItem('highScore', gameStats.highScore);
                }
                
                localStorage.setItem('gamesWon', gameStats.gamesWon);
                localStorage.setItem('gamesPlayed', gameStats.gamesPlayed);
                localStorage.setItem('streak', gameStats.streak);
                
                updateStats();
                checkAchievements();
                
                if (currentMode === 'survival' || currentMode === 'blitz') {
                    setTimeout(() => {
                        blitzRounds++;
                        initGame();
                    }, 1500);
                } else {
                    showWinPopup();
                }
            }
        }

        // Powerup functions
        function useHint() {
            if (powerUps.hints <= 0 || gameState !== 'playing') return;
            
            powerUps.hints--;
            updatePowerUpDisplay();
            
            // Find a safe cell to highlight
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    if (!board[i][j].isRevealed && !board[i][j].isMine && !board[i][j].isFlagged) {
                        const cell = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
                        cell.classList.add('hint');
                        setTimeout(() => cell.classList.remove('hint'), 2000);
                        return;
                    }
                }
            }
        }

        function useUndo() {
            if (powerUps.undos <= 0 || !lastMove || gameState !== 'playing') return;
            
            powerUps.undos--;
            updatePowerUpDisplay();
            
            const { row, col, action, wasFlagged } = lastMove;
            
            if (action === 'reveal') {
                board[row][col].isRevealed = false;
                gameStats.score = Math.max(0, gameStats.score - 10);
                gameStats.gemsCollected = Math.max(0, gameStats.gemsCollected - 1);
            } else if (action === 'flag') {
                board[row][col].isFlagged = wasFlagged;
            }
            
            lastMove = null;
            renderBoard();
            updateStats();
        }

        function useSafeReveal() {
            if (powerUps.safeReveals <= 0 || gameState !== 'playing') return;
            
            powerUps.safeReveals--;
            updatePowerUpDisplay();
            
            // Find and reveal a safe cell
            for (let i = 0; i < boardSize; i++) {
                for (let j = 0; j < boardSize; j++) {
                    if (!board[i][j].isRevealed && !board[i][j].isMine && !board[i][j].isFlagged) {
                        handleCellClick(i, j);
                        return;
                    }
                }
            }
        }

        function updatePowerUpDisplay() {
            document.getElementById('hintsLeft').textContent = powerUps.hints;
            document.getElementById('undosLeft').textContent = powerUps.undos;
            document.getElementById('safeRevealsLeft').textContent = powerUps.safeReveals;
            
            document.getElementById('hintBtn').disabled = powerUps.hints <= 0;
            document.getElementById('undoBtn').disabled = powerUps.undos <= 0 || !lastMove;
            document.getElementById('safeRevealBtn').disabled = powerUps.safeReveals <= 0;
        }

        // Popup functions
        function showGameOverPopup() {
            const title = currentMode === 'survival' ? 
                `Survival Round ${roundCount}` : 'Game Over!';
            const message = currentMode === 'survival' ? 
                `You survived ${roundCount} rounds!` : 'You hit a mine!';
            
            showPopup(title, message);
        }

        function showWinPopup() {
            showPopup('Congratulations!', 'You found all the gems!');
        }

        function showPopup(title, message) {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').textContent = message;
            
            const stats = `
                Score: ${gameStats.score} | 
                Time: ${document.getElementById('timer').textContent} | 
                Streak: ${gameStats.streak}
            `;
            document.getElementById('popupStats').textContent = stats;
            
            document.getElementById('popupOverlay').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('popupOverlay').style.display = 'none';
        }

        function shareResult() {
            const text = `I scored ${gameStats.score} points in Ultimate Minesweeper! Current streak: ${gameStats.streak}. Can you beat me?`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Ultimate Minesweeper',
                    text: text,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(text + ' ' + window.location.href)
                    .then(() => alert('Result copied to clipboard!'));
            }
        }

        function showAchievements() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = achievements.map(achievement => `
                <div class="achievement-item ${achievement.unlocked ? 'unlocked' : 'locked'}">
                    <span class="achievement-icon">${achievement.unlocked ? achievement.icon : '🔒'}</span>
                    <div class="achievement-info">
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-description">${achievement.desc}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('achievementsOverlay').style.display = 'flex';
        }

        function closeAchievements() {
            document.getElementById('achievementsOverlay').style.display = 'none';
        }

        function resetGame() {
            stopTimer();
            if (currentMode !== 'survival') {
                roundCount = 0;
                blitzRounds = 0;
            }
            initGame();
        }

        // Reset progress functions
        function showResetConfirm() {
            document.getElementById('resetConfirmOverlay').style.display = 'flex';
        }

        function closeResetConfirm() {
            document.getElementById('resetConfirmOverlay').style.display = 'none';
        }

        function resetAllProgress() {
            // Clear all localStorage data
            localStorage.removeItem('highScore');
            localStorage.removeItem('totalGems');
            localStorage.removeItem('gamesPlayed');
            localStorage.removeItem('gamesWon');
            localStorage.removeItem('streak');
            localStorage.removeItem('achievements');
            
            // Reset current game stats
            gameStats = {
                score: 0,
                streak: 0,
                highScore: 0,
                gemsCollected: 0,
                gamesPlayed: 0,
                gamesWon: 0
            };
            
            // Reset achievements
            initAchievements();
            
            // Update display
            updateStats();
            
            // Close popup
            closeResetConfirm();
            
            // Show confirmation
            alert('All progress has been reset successfully!');
            
            // Restart current game
            resetGame();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initAchievements();
            updateStats();
            
            // Mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => setGameMode(btn.dataset.mode));
            });
            
            // Theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => setTheme(btn.dataset.theme));
            });
            
            // Difficulty buttons
            document.querySelectorAll('.diff-btn').forEach(btn => {
                btn.addEventListener('click', () => 
                    setDifficulty(btn.dataset.size, btn.dataset.mines));
            });
            
            // Global mouse events for drag functionality
            document.addEventListener('mouseup', handleMouseUp);
            document.addEventListener('mouseleave', handleMouseUp);
            
            initGame();
        });
    </script>
</body>
</html>